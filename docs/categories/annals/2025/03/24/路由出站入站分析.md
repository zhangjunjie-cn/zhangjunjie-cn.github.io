---
date: 2025/03/24 17:14
isTop: true
title: 路由出站入站分析
author: 张俊杰
articleGPT: 这是一篇关于
categories:
 - 博客
tags:
 - 防火墙路由
---

# 路由出站入站分析

::: code-group
```shell [执行命令：diagnose sniffer packet any "host 8.8.8.8" 4]
6.711428 port4 in 172.20.80.61.59827 -> 8.8.8.8.53: udp 31
6.711430 办公网1 in 172.20.80.61.59827 -> 8.8.8.8.53: udp 31
6.711441 port2 out 222.178.157.95.59827 -> 8.8.8.8.53: udp 31
6.756928 port2 in 8.8.8.8.53 -> 222.178.157.95.59827: udp 116
6.756945 办公网1 out 8.8.8.8.53 -> 172.20.80.61.59827: udp 116
6.756946 port4 out 8.8.8.8.53 -> 172.20.80.61.59827: udp 116
7.396115 port12 in 172.29.82.27.36798 -> 8.8.8.8.53: udp 29
```
:::

这段日志是一个 **UDP/DNS 查询与响应的完整网络流量记录**，涉及 **NAT（网络地址转换）** 和多个网络接口。以下是详细解析：

---

### **日志结构**
每行格式：  
**`时间戳 网络接口 方向 源IP.源端口 -> 目标IP.目标端口: 协议 数据包大小`**

- **时间戳**：单位可能是秒（如 `6.711428`）。  
- **网络接口**：如 `port2`、`办公网1`，代表设备的不同物理或逻辑接口。  
- **方向**：`in`（入站）、`out`（出站）。  
- **IP和端口**：如 `172.20.80.61.59827`（内网主机+随机端口）、`8.8.8.8.53`（Google DNS）。  
- **协议**：`udp`（DNS 默认使用 UDP 协议）。  
- **数据包大小**：如 `31`（查询）、`116`（响应），单位是字节。

---

### **完整流程分析**

#### **1. 内网主机发起 DNS 查询（出站）**
- **`6.711428 port4 in 172.20.80.61.59827 -> 8.8.8.8.53: udp 31`**  
  - 内网主机 `172.20.80.61` 从 `port4` 接口发送 DNS 查询到 `8.8.8.8`（Google DNS）。  
  - **疑问**：为什么同一查询会出现在多个接口？可能是多路径传输或日志冗余记录。

- **`6.711430 办公网1 in 172.20.80.61.59827 -> 8.8.8.8.53: udp 31`**  
  - 同一 DNS 查询也从 `办公网1` 接口进入设备（可能是负载均衡或多接口绑定）。

- **`6.711441 port2 out 222.178.157.95.59827 -> 8.8.8.8.53: udp 31`**  
  - 经过 **NAT 转换**，内网 IP `172.20.80.61` 被映射为公网 IP `222.178.157.95`。  
  - 查询从 `port2` 接口出站，目标仍是 `8.8.8.8.53`。

#### **2. DNS 服务器返回响应（入站）**
- **`6.756928 port2 in 8.8.8.8.53 -> 222.178.157.95.59827: udp 116`**  
  - Google DNS (`8.8.8.8`) 返回响应，目标为 NAT 后的公网 IP `222.178.157.95`。  
  - 数据包大小 `116` 字节（DNS 响应通常比查询大）。

#### **3. 响应返回内网主机（NAT 回译）**
- **`6.756945 办公网1 out 8.8.8.8.53 -> 172.20.80.61.59827: udp 116`**  
  - 设备将响应通过 `办公网1` 接口送回内网主机 `172.20.80.61`（NAT 反向转换）。  

- **`6.756946 port4 out 8.8.8.8.53 -> 172.20.80.61.59827: udp 116`**  
  - 同一响应也可能从 `port4` 接口送出（可能是冗余转发或日志重复记录）。

#### **4. 另一内网主机的 DNS 查询**
- **`7.396115 port12 in 172.29.82.27.36798 -> 8.8.8.8.53: udp 29`**  
  - 另一内网主机 `172.29.82.27` 发起新的 DNS 查询（端口 `36798`，数据包 `29` 字节）。  
  - 尚未看到后续响应（可能日志截断或响应未记录）。

---

### **关键结论**
1. **NAT 工作正常**：  
   - 内网 IP `172.20.80.61` ↔ 公网 IP `222.178.157.95` 的转换成功。  
   - 查询和响应均通过 NAT 设备正确路由。

2. **多接口流量**：  
   - 同一数据包可能从不同接口进出（如 `port4` 和 `办公网1`），可能是由于：  
     - 接口冗余（如链路聚合）。  
     - 日志记录覆盖所有路径。  

3. **DNS 使用 UDP**：  
   - 短查询（`31` 字节）和长响应（`116` 字节）符合 DNS 协议特征。  

4. **可能的网络拓扑**：  
   - 内网网段：`172.20.80.0/24`、`172.29.82.0/24`。  
   - 公网 IP：`222.178.157.95` 可能是企业出口 IP。  
   - 设备接口：`port2`（连接外网）、`办公网1`/`port4`（连接内网）。

---

### **异常点排查**
- **重复日志**：  
  - 同一 DNS 查询在 `port4` 和 `办公网1` 均被记录，需确认是否为设备配置（如多接口监听）或日志冗余。  
- **未记录的响应**：  
  - 第二台主机 (`172.29.82.27`) 的 DNS 响应未出现在日志中，可能是截断或丢包。  

---

### **用途**
- **网络调试**：验证 NAT、DNS 解析、接口流量是否正常。  
- **安全分析**：检查是否有异常外连（如内网主机擅自访问外部 DNS）。  

如果需要进一步分析，可以提供设备型号或网络拓扑图！
