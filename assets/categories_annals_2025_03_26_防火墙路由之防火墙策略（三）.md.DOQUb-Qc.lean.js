import{_ as c}from"./chunks/ArticleGPT.DcRZmdDi.js";import{_ as g}from"./chunks/ArticleMetadata.CccXcOgE.js";import{_ as u,z as t,A as b,B as r,c as m,G as a,S as A,M as F,P as y,ap as f,O as n}from"./chunks/framework.DX_QNVSv.js";import"./chunks/index.zebejNkg.js";import"./chunks/theme.ChJNmxi9.js";const G=JSON.parse('{"title":"防火墙路由之防火墙策略（三）","description":"","frontmatter":{"date":"2025/03/26 22:31","isTop":false,"title":"防火墙路由之防火墙策略（三）","author":"张俊杰","articleGPT":"这是一篇关于","categories":["博客"],"tags":["防火墙路由"]},"headers":[],"relativePath":"categories/annals/2025/03/26/防火墙路由之防火墙策略（三）.md","filePath":"categories/annals/2025/03/26/防火墙路由之防火墙策略（三）.md","lastUpdated":1743046853000}'),C={name:"categories/annals/2025/03/26/防火墙路由之防火墙策略（三）.md"};function D(i,s,q,B,_,v){const p=g,o=n("ClientOnly"),h=c,d=n("NolebaseGitContributors"),k=n("NolebaseGitChangelog");return t(),b("div",null,[s[0]||(s[0]=r("h1",{id:"防火墙路由之防火墙策略-三",tabindex:"-1"},[m("防火墙路由之防火墙策略（三） "),r("a",{class:"header-anchor",href:"#防火墙路由之防火墙策略-三","aria-label":'Permalink to "防火墙路由之防火墙策略（三）"'},"​")],-1)),a(o,null,{default:A(()=>{var e,l;return[(((e=i.$frontmatter)==null?void 0:e.aside)??!0)&&(((l=i.$frontmatter)==null?void 0:l.showArticleMetadata)??!0)?(t(),F(p,{key:0,article:i.$frontmatter},null,8,["article"])):y("",!0)]}),_:1}),a(h),s[1]||(s[1]=f(`<figure><img src="https://gitee.com/zhangjunjiee/article-images/raw/master/images/20250326233236901.png" alt="静态路由" tabindex="0"><figcaption>静态路由</figcaption></figure><p>静态路由是最原始的，如果你用策略路由的话，会覆盖他的优先级。然后，静态路由的配置，一般只需要一个同外网的出口就行了。策略路由，也可以叫做自定义静态路由，他的优先级可以比静态路由还高，一般用于网络出口，选择哪一个WAN的出口方向，但是要注意的是，防火墙策略的优先级很高，他是作用于局域网内不同LAN之间和NAT的，所以他可以配置一个PORT有不同的出口方向，并且可以均衡的分布流量，但是，如何你配置了一条策略路由，他的出口流向就被锁定了，就会只允许这一个出口的方向。比如，我的办公网在防火墙策略里面配置了多个互通网段，比如访问监控段，WIFI段，考勤段等等，但如果你配置了一条策略路由出口WAN，那么办公网的防火墙策略就会失效，只会允许让他出口指定的WAN，所以，办公网的策略路由出口WAN可以不用配置，0.0.0.0/0 [10/0] via 222.178.157.65, port2, [1/0] [10/0] via 183.230.155.1, port1, [2/0]，静态路由就已经配置了公网出口，不用专门配置一条通WAN的策略路由，也可以访问外网。</p><figure><img src="https://gitee.com/zhangjunjiee/article-images/raw/master/images/20250326233616707.png" alt="策略路由" tabindex="0"><figcaption>策略路由</figcaption></figure><figure><img src="https://gitee.com/zhangjunjiee/article-images/raw/master/images/20250326233827501.png" alt="防火墙策略" tabindex="0"><figcaption>防火墙策略</figcaption></figure><h3 id="📝-我的网络配置踩坑笔记-当策略路由-杀死-了内网访问" tabindex="-1"><strong>📝 我的网络配置踩坑笔记：当策略路由&quot;杀死&quot;了内网访问</strong> <a class="header-anchor" href="#📝-我的网络配置踩坑笔记-当策略路由-杀死-了内网访问" aria-label="Permalink to &quot;**📝 我的网络配置踩坑笔记：当策略路由&quot;杀死&quot;了内网访问**&quot;">​</a></h3><h4 id="🚦-故事背景" tabindex="-1"><strong>🚦 故事背景</strong> <a class="header-anchor" href="#🚦-故事背景" aria-label="Permalink to &quot;**🚦 故事背景**&quot;">​</a></h4><p>最近在公司防火墙上做了以下配置：</p><ol><li><strong>防火墙策略</strong>：允许办公网（<code>办公网1</code>）与监控段/WiFi段/考勤段互通</li><li><strong>静态路由</strong>：配置了双WAN出口（电信<code>port2</code>主用，移动<code>port1</code>备用）</li><li><strong>策略路由</strong>：想让办公网所有外网流量走电信WAN，于是加了这条：<div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes one-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#F69D50;">edit</span><span style="--shiki-light:#986801;--shiki-dark:#6CB6FF;"> 11</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#6CB6FF;">    set</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> input-device</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> &quot;办公网1&quot;</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#6CB6FF;">    set</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> srcaddr</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> &quot;all&quot;</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#6CB6FF;">    set</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> dstaddr</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> &quot;all&quot;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#768390;--shiki-dark-font-style:inherit;">           # 全流量匹配</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#6CB6FF;">    set</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> output-device</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> &quot;port2&quot;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#768390;--shiki-dark-font-style:inherit;">   # 强制走电信</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ol><h4 id="💥-问题现象" tabindex="-1"><strong>💥 问题现象</strong> <a class="header-anchor" href="#💥-问题现象" aria-label="Permalink to &quot;**💥 问题现象**&quot;">​</a></h4><p>配置完成后：</p><ul><li>办公网访问外网正常（走电信）</li><li><strong>但办公网突然无法访问监控摄像头！</strong><br> （明明防火墙策略<code>edit 21</code>允许办公网→监控段）</li></ul><h4 id="🔍-排查过程" tabindex="-1">🔍 <strong>排查过程</strong> <a class="header-anchor" href="#🔍-排查过程" aria-label="Permalink to &quot;🔍 **排查过程**&quot;">​</a></h4><ol><li>检查防火墙策略 → 规则存在且命中计数增加</li><li>执行流量跟踪：<div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes one-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#F69D50;">diagnose</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> debug</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> flow</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> trace</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> start</span><span style="--shiki-light:#986801;--shiki-dark:#6CB6FF;"> 100</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> filter</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> saddr</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> 办公网IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> daddr</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> 监控段IP</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><strong>发现真相</strong>： <ul><li>流量匹配了策略路由的<code>dstaddr all</code></li><li>被强制推向<code>port2</code>（电信WAN）</li><li>监控段无法通过WAN口回程 → 通信中断</li></ul></li></ol><h3 id="🔧-策略路由冲突的mermaid流程图" tabindex="-1"><strong>🔧 策略路由冲突的Mermaid流程图</strong> <a class="header-anchor" href="#🔧-策略路由冲突的mermaid流程图" aria-label="Permalink to &quot;**🔧 策略路由冲突的Mermaid流程图**&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes one-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">graph TD</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    A[办公网PC] --&gt;|访问监控摄像头| B{防火墙策略}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    B --&gt;|规则21: 允许访问| C{策略路由}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    C --&gt;|规则11: dstaddr=all 强制走port2| D[流量被错误导向电信WAN]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    D --&gt; E[监控段无法响应] --&gt; F[通信失败]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    C --&gt;|未匹配策略路由| G[静态路由]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    G --&gt;|默认路由0.0.0.0/0| H[正常走port2主用]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    G --&gt;|监控段路由10.253.132.0/23| I[走VPN隧道]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    style A fill:#cff,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    style B fill:#f9f,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    style C fill:#f96,stroke:#333</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    style D color:red,stroke:#f00</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    style F color:red</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    style G fill:#9f9,stroke:#090</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    style H,I fill:#cfc,stroke:#090</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    linkStyle 2,3 stroke:#090,stroke-width:2px</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ADBAC7;">    linkStyle 4 stroke:#f00,stroke-width:2px</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><hr><h4 id="🎨-图表说明" tabindex="-1"><strong>🎨 图表说明</strong> <a class="header-anchor" href="#🎨-图表说明" aria-label="Permalink to &quot;**🎨 图表说明**&quot;">​</a></h4><ol><li><strong>红色故障流</strong>：展示因<code>dstaddr=all</code>导致的内网访问中断</li><li><strong>绿色正确流</strong>：对比修正后的理想状态</li><li><strong>关键节点标注</strong>： <ul><li>防火墙策略（紫色）：权限检查点</li><li>策略路由（橙色）：路径强制点</li><li>冲突点（红色边框）：错误配置位置</li></ul></li></ol><hr><h4 id="🧠-问题本质" tabindex="-1">🧠 <strong>问题本质</strong> <a class="header-anchor" href="#🧠-问题本质" aria-label="Permalink to &quot;🧠 **问题本质**&quot;">​</a></h4><p>策略路由像&quot;霸道总裁&quot;，<strong>只要匹配就强制执行</strong>，完全不管：</p><ul><li>防火墙是否已放行</li><li>目标地址是否是内网</li><li>是否会影响其他业务</li></ul><h4 id="✅-解决方案" tabindex="-1">✅ <strong>解决方案</strong> <a class="header-anchor" href="#✅-解决方案" aria-label="Permalink to &quot;✅ **解决方案**&quot;">​</a></h4><p>给策略路由加上&quot;排除条款&quot;：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes one-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#F69D50;">edit</span><span style="--shiki-light:#986801;--shiki-dark:#6CB6FF;"> 11</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#6CB6FF;">    set</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> dstaddr</span><span style="--shiki-light:#50A14F;--shiki-dark:#96D0FF;"> &quot;!10.253.132.0/23 !172.18.20.0/23 !192.168.0.0/16&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>（所有内网段前加<code>!</code>表示排除）</p><h4 id="💡-经验总结" tabindex="-1">💡 <strong>经验总结</strong> <a class="header-anchor" href="#💡-经验总结" aria-label="Permalink to &quot;💡 **经验总结**&quot;">​</a></h4><ol><li><p><strong>策略路由是&quot;外科手术刀&quot;</strong>：</p><ul><li>精准控制特定流量（如：仅外网走电信）</li><li>绝不滥用<code>dstaddr all</code>这种&quot;核武器&quot;</li></ul></li><li><p><strong>防火墙策略才是&quot;大管家&quot;</strong>：</p><ul><li>内网互访规则应该交给防火墙策略管理</li><li>策略路由只辅助做路径优化</li></ul></li><li><p><strong>配置口诀</strong>：</p><blockquote><p>&quot;防火策略开权限，策略路由调路线<br> 内网地址要排除，全量匹配最危险&quot;</p></blockquote></li></ol><p>（附当时的问题截图和解决后的流量跟踪对比图）</p><hr><p>这样改写是否更符合您博客笔记的风格？如需调整细节可随时告诉我~</p>`,31)),a(d),a(k)])}const T=u(C,[["render",D]]);export{G as __pageData,T as default};
