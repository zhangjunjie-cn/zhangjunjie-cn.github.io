import{_ as r}from"./chunks/WDocTitleMeta.D7SBSfeW.js";import{_ as d,C as h,c as p,o as l,j as e,G as k,aT as c,a as g,w as F,b as u,e as y}from"./chunks/framework.CAnzeOY9.js";import"./chunks/theme.DXmJrc9n.js";const P=JSON.parse('{"title":"路由出站入站分析","description":"防火墙的流程思想，一般，可以看看，后续整理整理。","frontmatter":{"lastUpdated":"2025-11-09 21:59:26+8:00","firstCommit":"2025/03/24 17:14","title":"路由出站入站分析","description":"防火墙的流程思想，一般，可以看看，后续整理整理。","tags":["防火墙路由"]},"headers":[],"relativePath":"博客/2025/03/路由出站入站分析.md","filePath":"博客/2025/03/路由出站入站分析.md","lastUpdated":1762696766000}'),C={name:"博客/2025/03/路由出站入站分析.md"};function E(i,s,b,B,m,_){const n=r,o=h("ClientOnly");return l(),p("div",null,[s[0]||(s[0]=e("h1",{id:"路由出站入站分析",tabindex:"-1"},[g("路由出站入站分析 "),e("a",{class:"header-anchor",href:"#路由出站入站分析","aria-label":'Permalink to "路由出站入站分析"'},"​")],-1)),k(o,null,{default:F(()=>{var a,t;return[(((a=i.$frontmatter)==null?void 0:a.aside)??!0)&&(((t=i.$frontmatter)==null?void 0:t.showWDocTitleMeta)??!0)?(l(),u(n,{key:0,article:i.$frontmatter},null,8,["article"])):y("",!0)]}),_:1}),s[1]||(s[1]=c(`<div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-8byJb" id="tab-Fgqi2vu" checked><label data-title="执行命令：diagnose sniffer packet any &quot;host 8.8.8.8&quot; 4" for="tab-Fgqi2vu">执行命令：diagnose sniffer packet any &quot;host 8.8.8.8&quot; 4</label></div><div class="blocks"><div class="language-shell vp-adaptive-theme active line-numbers-mode"><button title="复制代码" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">6.711428</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.20.80.61.59827</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8.8.8.8.53:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> udp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 31</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">6.711430</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 办公网1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.20.80.61.59827</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8.8.8.8.53:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> udp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 31</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">6.711441</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> out</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 222.178.157.95.59827</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8.8.8.8.53:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> udp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 31</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">6.756928</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8.8.8.8.53</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 222.178.157.95.59827:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> udp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 116</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">6.756945</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 办公网1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> out</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8.8.8.8.53</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 172.20.80.61.59827:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> udp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 116</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">6.756946</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> out</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8.8.8.8.53</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 172.20.80.61.59827:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> udp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 116</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">7.396115</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port12</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.29.82.27.36798</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8.8.8.8.53:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> udp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 29</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></div></div><p>这段日志是一个 <strong>UDP/DNS 查询与响应的完整网络流量记录</strong>，涉及 <strong>NAT（网络地址转换）</strong> 和多个网络接口。以下是详细解析：</p><hr><h3 id="日志结构" tabindex="-1"><strong>日志结构</strong> <a class="header-anchor" href="#日志结构" aria-label="Permalink to &quot;**日志结构**&quot;">​</a></h3><p>每行格式：<br><strong><code>时间戳 网络接口 方向 源IP.源端口 -&gt; 目标IP.目标端口: 协议 数据包大小</code></strong></p><ul><li><strong>时间戳</strong>：单位可能是秒（如 <code>6.711428</code>）。</li><li><strong>网络接口</strong>：如 <code>port2</code>、<code>办公网1</code>，代表设备的不同物理或逻辑接口。</li><li><strong>方向</strong>：<code>in</code>（入站）、<code>out</code>（出站）。</li><li><strong>IP和端口</strong>：如 <code>172.20.80.61.59827</code>（内网主机+随机端口）、<code>8.8.8.8.53</code>（Google DNS）。</li><li><strong>协议</strong>：<code>udp</code>（DNS 默认使用 UDP 协议）。</li><li><strong>数据包大小</strong>：如 <code>31</code>（查询）、<code>116</code>（响应），单位是字节。</li></ul><hr><h3 id="完整流程分析" tabindex="-1"><strong>完整流程分析</strong> <a class="header-anchor" href="#完整流程分析" aria-label="Permalink to &quot;**完整流程分析**&quot;">​</a></h3><h4 id="_1-内网主机发起-dns-查询-出站" tabindex="-1"><strong>1. 内网主机发起 DNS 查询（出站）</strong> <a class="header-anchor" href="#_1-内网主机发起-dns-查询-出站" aria-label="Permalink to &quot;**1. 内网主机发起 DNS 查询（出站）**&quot;">​</a></h4><ul><li><p><strong><code>6.711428 port4 in 172.20.80.61.59827 -&gt; 8.8.8.8.53: udp 31</code></strong></p><ul><li>内网主机 <code>172.20.80.61</code> 从 <code>port4</code> 接口发送 DNS 查询到 <code>8.8.8.8</code>（Google DNS）。</li><li><strong>疑问</strong>：为什么同一查询会出现在多个接口？可能是多路径传输或日志冗余记录。</li></ul></li><li><p><strong><code>6.711430 办公网1 in 172.20.80.61.59827 -&gt; 8.8.8.8.53: udp 31</code></strong></p><ul><li>同一 DNS 查询也从 <code>办公网1</code> 接口进入设备（可能是负载均衡或多接口绑定）。</li></ul></li><li><p><strong><code>6.711441 port2 out 222.178.157.95.59827 -&gt; 8.8.8.8.53: udp 31</code></strong></p><ul><li>经过 <strong>NAT 转换</strong>，内网 IP <code>172.20.80.61</code> 被映射为公网 IP <code>222.178.157.95</code>。</li><li>查询从 <code>port2</code> 接口出站，目标仍是 <code>8.8.8.8.53</code>。</li></ul></li></ul><h4 id="_2-dns-服务器返回响应-入站" tabindex="-1"><strong>2. DNS 服务器返回响应（入站）</strong> <a class="header-anchor" href="#_2-dns-服务器返回响应-入站" aria-label="Permalink to &quot;**2. DNS 服务器返回响应（入站）**&quot;">​</a></h4><ul><li><strong><code>6.756928 port2 in 8.8.8.8.53 -&gt; 222.178.157.95.59827: udp 116</code></strong><ul><li>Google DNS (<code>8.8.8.8</code>) 返回响应，目标为 NAT 后的公网 IP <code>222.178.157.95</code>。</li><li>数据包大小 <code>116</code> 字节（DNS 响应通常比查询大）。</li></ul></li></ul><h4 id="_3-响应返回内网主机-nat-回译" tabindex="-1"><strong>3. 响应返回内网主机（NAT 回译）</strong> <a class="header-anchor" href="#_3-响应返回内网主机-nat-回译" aria-label="Permalink to &quot;**3. 响应返回内网主机（NAT 回译）**&quot;">​</a></h4><ul><li><p><strong><code>6.756945 办公网1 out 8.8.8.8.53 -&gt; 172.20.80.61.59827: udp 116</code></strong></p><ul><li>设备将响应通过 <code>办公网1</code> 接口送回内网主机 <code>172.20.80.61</code>（NAT 反向转换）。</li></ul></li><li><p><strong><code>6.756946 port4 out 8.8.8.8.53 -&gt; 172.20.80.61.59827: udp 116</code></strong></p><ul><li>同一响应也可能从 <code>port4</code> 接口送出（可能是冗余转发或日志重复记录）。</li></ul></li></ul><h4 id="_4-另一内网主机的-dns-查询" tabindex="-1"><strong>4. 另一内网主机的 DNS 查询</strong> <a class="header-anchor" href="#_4-另一内网主机的-dns-查询" aria-label="Permalink to &quot;**4. 另一内网主机的 DNS 查询**&quot;">​</a></h4><ul><li><strong><code>7.396115 port12 in 172.29.82.27.36798 -&gt; 8.8.8.8.53: udp 29</code></strong><ul><li>另一内网主机 <code>172.29.82.27</code> 发起新的 DNS 查询（端口 <code>36798</code>，数据包 <code>29</code> 字节）。</li><li>尚未看到后续响应（可能日志截断或响应未记录）。</li></ul></li></ul><hr><h3 id="关键结论" tabindex="-1"><strong>关键结论</strong> <a class="header-anchor" href="#关键结论" aria-label="Permalink to &quot;**关键结论**&quot;">​</a></h3><ol><li><p><strong>NAT 工作正常</strong>：</p><ul><li>内网 IP <code>172.20.80.61</code> ↔ 公网 IP <code>222.178.157.95</code> 的转换成功。</li><li>查询和响应均通过 NAT 设备正确路由。</li></ul></li><li><p><strong>多接口流量</strong>：</p><ul><li>同一数据包可能从不同接口进出（如 <code>port4</code> 和 <code>办公网1</code>），可能是由于： <ul><li>接口冗余（如链路聚合）。</li><li>日志记录覆盖所有路径。</li></ul></li></ul></li><li><p><strong>DNS 使用 UDP</strong>：</p><ul><li>短查询（<code>31</code> 字节）和长响应（<code>116</code> 字节）符合 DNS 协议特征。</li></ul></li><li><p><strong>可能的网络拓扑</strong>：</p><ul><li>内网网段：<code>172.20.80.0/24</code>、<code>172.29.82.0/24</code>。</li><li>公网 IP：<code>222.178.157.95</code> 可能是企业出口 IP。</li><li>设备接口：<code>port2</code>（连接外网）、<code>办公网1</code>/<code>port4</code>（连接内网）。</li></ul></li></ol><hr><h3 id="异常点排查" tabindex="-1"><strong>异常点排查</strong> <a class="header-anchor" href="#异常点排查" aria-label="Permalink to &quot;**异常点排查**&quot;">​</a></h3><ul><li><strong>重复日志</strong>： <ul><li>同一 DNS 查询在 <code>port4</code> 和 <code>办公网1</code> 均被记录，需确认是否为设备配置（如多接口监听）或日志冗余。</li></ul></li><li><strong>未记录的响应</strong>： <ul><li>第二台主机 (<code>172.29.82.27</code>) 的 DNS 响应未出现在日志中，可能是截断或丢包。</li></ul></li></ul><hr><h3 id="用途" tabindex="-1"><strong>用途</strong> <a class="header-anchor" href="#用途" aria-label="Permalink to &quot;**用途**&quot;">​</a></h3><ul><li><strong>网络调试</strong>：验证 NAT、DNS 解析、接口流量是否正常。</li><li><strong>安全分析</strong>：检查是否有异常外连（如内网主机擅自访问外部 DNS）。</li></ul><p>如果需要进一步分析，可以提供设备型号或网络拓扑图！</p>`,26))])}const S=d(C,[["render",E]]);export{P as __pageData,S as default};
